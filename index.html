<!doctype html>
<html>
<head>
  <title>Front-End Tinebase OTP</title>
  <script src="crypto-js.js"></script>
  <script>
    function hexToBytes(hex) {
      return (hex.match(/.{1,2}/g) ?? []).map(char => Number.parseInt(char, 16));
    }

    function computeHMACSha1(message, key) {
      return CryptoJS.HmacSHA1(CryptoJS.enc.Hex.parse(message), CryptoJS.enc.Hex.parse(base32toHex(key))).toString(CryptoJS.enc.Hex);
    }

    function base32toHex(base32) {
      const base32Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';

      const bits = base32
        .toUpperCase()
        .replace(/=+$/, '')
        .split('')
        .map(value => base32Chars.indexOf(value).toString(2).padStart(5, '0'))
        .join('');

      const hex = (bits.match(/.{1,8}/g) ?? []).map(chunk => Number.parseInt(chunk, 2).toString(16).padStart(2, '0')).join('');

      return hex;
    }

    function generateHOTP({ key, counter = 0 }) {
      const digest = computeHMACSha1(counter.toString(16).padStart(16, '0'), key);

      const bytes = hexToBytes(digest);

      const offset = bytes[19] & 0xF;
      const v
        = ((bytes[offset] & 0x7F) << 24)
        | ((bytes[offset + 1] & 0xFF) << 16)
        | ((bytes[offset + 2] & 0xFF) << 8)
        | (bytes[offset + 3] & 0xFF);

      const code = String(v % 1000000).padStart(6, '0');

      return code;
    }

    function verifyHOTP({
      token,
      key,
      window = 0,
      counter = 0,
    }) {
      for (let i = counter - window; i <= counter + window; ++i) {
        if (generateHOTP({ key, counter: i }) === token) {
          return true;
        }
      }

      return false;
    }

    function getCounterFromTime({ now, timeStep }) {
      return Math.floor(now / 1000 / timeStep);
    }

    function generateTOTP({ key, now = Date.now(), timeStep = 30 }) {
      const counter = getCounterFromTime({ now, timeStep });

      return generateHOTP({ key, counter });
    }

    function verifyTOTP({
      key,
      token,
      window = 0,
      now = Date.now(),
      timeStep = 30,
    }) {
      const counter = getCounterFromTime({ now, timeStep });

      return verifyHOTP({ token, key, window, counter });
    }

    function generateSecret() {
      return createToken({ length: 16, alphabet: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567' });
    }

    function generateOtp() {
      const key = document.getElementById("key-input").value;
      const otp = generateTOTP({ key });
      document.getElementById("otp-display").innerHTML = otp;
      const counter = getCounterFromTime({ now: Date.now(), timeStep: 30 });
      document.getElementById("counter-display").innerHTML = counter;
      const remaining = 30 - (Date.now() / 1000) % 30;
      document.getElementById("progress-display").value = remaining;
      document.getElementById("time-display").innerHTML = remaining;
    }

    function verifyOtp() {
      const key = document.getElementById("key-input").value;
      const otp = document.getElementById("otp-input").value;
      const result = verifyTOTP({ key, token: otp });
      if (result) {
        document.getElementById("result-display").innerHTML = "True";
      } else {
        document.getElementById("result-display").innerHTML = "False";
      }
    }
  </script>
</head>
<body>
  <h1>Timebase OTP Generator/Validator</h1>
  <a href="https://github.com/M3351AN/Front-End-Tinebase-OTP">Github repo</a><br><br>
  <input id="key-input" type="text" placeholder="Key" />
  <button id="generate-button" onclick="generateOtp()">generate</button>
  <p>Iteration:<span id="counter-display">0</span></p>
  <p>Current OTP:<span id="otp-display">000000</span></p>
  <progress id="progress-display" value="0" max="30"></progress>
  <p>Time remain:<span id="time-display">0</span> secs</p>
  <input id="otp-input" type="text" placeholder="OTP" />
  <button id="verify-button" onclick="verifyOtp()">verify</button>
  <p id="result-display"></p>
</body>
<script>
  setInterval(() => {
    generateOtp();
  }, 1000);
</script>
</html>
